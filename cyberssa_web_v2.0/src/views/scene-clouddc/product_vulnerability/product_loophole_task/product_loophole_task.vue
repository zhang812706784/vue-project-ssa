<template>
  <div class="loophole-task">
    <!-- <div class="loophole-task-tool-bar">
      <Icon type="help-circled" size="22" color="skyblue" style="vertical-align: middle;margin-right:8px"></Icon>
      <Dropdown placement="bottom-start">
        <a href="javascript:void(0)">
          <Icon type="ios-color-wand-outline" color="pink" size="22" style="vertical-align: middle;margin-right:8px"></Icon>
        </a>
        <DropdownMenu slot="list">
          <DropdownItem>Task Wizard</DropdownItem>
          <DropdownItem>Advanced Task Wizard</DropdownItem>
          <DropdownItem>Modify Task Wizard</DropdownItem>
        </DropdownMenu>
      </Dropdown>
      <Dropdown placement="bottom-start">
        <a href="javascript:void(0)">
          <Icon type="android-add-circle" color="green" size="22" style="vertical-align: middle;"></Icon>
        </a>
        <DropdownMenu slot="list">
          <DropdownItem>new Task</DropdownItem>
          <DropdownItem>new Container Task</DropdownItem>
        </DropdownMenu>
      </Dropdown>
    </div> -->
    <div class="loophole-task-container">
      <!-- <div class="loophole-task-title">
        <h3>
          <Icon type="clipboard" color="lightblue" size="22" style="vertical-align: middle;margin-right:8px"></Icon>Task(94 of 94)
        </h3>
        <Icon type="ios-gear" color="skyblue" size="22" style="vertical-align: middle;"></Icon>
      </div> -->
      <div class="loophole-task-display">
        <div class="loophole-task-severity">
          <div class="loophole-task-chart-title">
            <Dropdown class="loophole-task-chart-title-menu" placement="bottom-start">
              <a href="javascript:void(0)">
                <Icon type="ios-arrow-down"></Icon>
              </a>
              <DropdownMenu slot="list">
                <DropdownItem>Show datached chart window</DropdownItem>
                <DropdownItem>Download CSV</DropdownItem>
                <DropdownItem>Show HTML table</DropdownItem>
                <DropdownItem>Show copyable SVG</DropdownItem>
                <DropdownItem>Download SVG</DropdownItem>
              </DropdownMenu>
            </Dropdown>Tasks by Severity Class (Total : 34)</div>
          <tp-ssa-echarts :allParams="chartOfserverity"></tp-ssa-echarts>
        </div>
        <div class="loophole-task-result">
          <div class="loophole-task-chart-title">
            <Dropdown class="loophole-task-chart-title-menu" placement="bottom-start">
              <a href="javascript:void(0)">
                <Icon type="ios-arrow-down"></Icon>
              </a>
              <DropdownMenu slot="list">
                <DropdownItem>Show datached chart window</DropdownItem>
                <DropdownItem>Download CSV</DropdownItem>
                <DropdownItem>Show HTML table</DropdownItem>
                <DropdownItem>Show copyable SVG</DropdownItem>
                <DropdownItem>Download SVG</DropdownItem>
              </DropdownMenu>
            </Dropdown>Tasks with most High results per host</div>
          <tp-ssa-echarts :allParams="chartOfserverity"></tp-ssa-echarts>
        </div>
        <div class="loophole-task-status">
          <div class="loophole-task-chart-title">
            <Dropdown class="loophole-task-chart-title-menu" placement="bottom-start">
              <a href="javascript:void(0)">
                <Icon type="ios-arrow-down"></Icon>
              </a>
              <DropdownMenu slot="list">
                <DropdownItem>Show datached chart window</DropdownItem>
                <DropdownItem>Download CSV</DropdownItem>
                <DropdownItem>Show HTML table</DropdownItem>
                <DropdownItem>Show copyable SVG</DropdownItem>
                <DropdownItem>Download SVG</DropdownItem>
              </DropdownMenu>
            </Dropdown>Task by status(Totla : 34)</div>
          <tp-ssa-echarts :allParams="chartOfserverity"></tp-ssa-echarts>
        </div>
      </div>
      <Tabs value="accessGroup">
        <TabPane label="资产分组" name="accessGroup">
          <div class="loophole-task-table">
            <tp-table ref="taskReportsOfAccessGroup" :all_params="taskReportsTableOfAccessGroup"></tp-table>
          </div>
        </TabPane>
        <TabPane label="服务器" name="server">
          <div class="loophole-task-table">
            <tp-table ref="taskReportsOfServer" :all_params="taskReportsTableOfServer"></tp-table>
          </div>
        </TabPane>
        <TabPane label="终端" name="vm">
          <div class="loophole-task-table">
            <tp-table ref="taskReportsOfVM" :all_params="taskReportsTableOfVM"></tp-table>
          </div>
        </TabPane>
      </Tabs>
      <Modal v-model="showAddSchedule" title="add schedule" @on-ok="addSchedule(newSchedule)">
        <Form label-position="left">
          <FormItem label="Name" :label-width="100">
            <Input type="text" size="small" v-model="newSchedule.name" style="width: 200px" placeholder="name">
            </Input>
          </FormItem>
          <FormItem label="Comment" :label-width="100">
            <Input type="text" size="small" v-model="newSchedule.comment" style="width: 200px" placeholder="comment">
            </Input>
          </FormItem>
          <FormItem label="First Time" :label-width="100">
            <DatePicker type="datetime" size="small" placeholder="Select date and time" style="width: 200px"></DatePicker>
          </FormItem>
          <FormItem label="Timezone" :label-width="100">
            <Select v-model="newSchedule.timezone" size="small" class="time-zone" style="width: 200px">
              <Option v-for="item in timeZoneList" :value="item.value" :key="item.value">{{ $t(item.key) }}</Option>
            </Select>
          </FormItem>
          <FormItem label="Period" :label-width="100">
            <InputNumber v-model="newSchedule.period.value" size="small" style="width: 100px"></InputNumber>
            <Select v-model="newSchedule.period.type" size="small" class="time-zone" style="width: 100px">
              <Option v-for="item in periodTypeList" :value="item.value" :key="item.value">{{ $t(item.name) }}</Option>
            </Select>
          </FormItem>
          <FormItem label="Duration" :label-width="100">
            <InputNumber v-model="newSchedule.duration.value" size="small" style="width: 100px"></InputNumber>
            <Select v-model="newSchedule.duration.type" size="small" class="time-zone" style="width: 100px">
              <Option v-for="item in durationTypeList" :value="item.value" :key="item.value">{{ $t(item.name) }}</Option>
            </Select>
          </FormItem>
        </Form>
      </Modal>
    </div>
  </div>
</template>

<script>
    import TpTable from '@/components/locale-components/tp-table/tp-table';
    import TpSsaEcharts from '@/components/locale-components/tp-ssa-echarts/tp-ssa-echarts';
    import mixin from '../mixin/mixin';
    export default {
        name: 'product_loophole_task',
        components: { TpSsaEcharts, TpTable },
        mixins: [mixin],
        data() {
            return {
                showTaskConfig: false, // 任务配置模态框
                showAddSchedule: false, // 时刻表新增模态框
                scheduleList: [],
                taskConfig: {},
                newSchedule: {
                    period: {},
                    duration: {}
                },
                chartOfserverity: {
                    //
                    id: 'IPRate',
                    type: 'circle',
                    title: 'Tasks by Severity Class (ToTal:34)',
                    // url: '/api/cr_net/net/flow_top_chart',
                    reload: 0
                    // data: {
                    //   flowType: 'UserIp',
                    //   direction: 'flow',
                    //   begTime: '',
                    //   endTime: ''
                    // }
                },
                taskReportsTableOfAccessGroup: {},
                taskReportsTableOfServer: {},
                taskReportsTableOfVM: {},
                timeZoneList: [
                    { key: 'GMT-11:00 阿皮亚', value: 'Pacific/Apia' },
                    { key: 'GMT-10:00 檀香山', value: 'Pacific/Honolulu' },
                    { key: 'GMT-09:30 马克萨斯', value: 'Pacific/Marquesas' },
                    { key: 'GMT-09:00 甘比尔', value: 'Pacific/Gambier' },
                    { key: 'GMT-08:00 皮特克恩岛', value: 'Pacific/Pitcairn' },
                    { key: 'GMT-07:00 凤凰城', value: 'America/Phoenix' },
                    { key: 'GMT-06:00 哥斯达黎加', value: 'America/Costa_Rica' },
                    { key: 'GMT-05:00 波哥达', value: 'America/Bogota' },
                    { key: 'GMT-04:00 瓜德罗普岛', value: 'America/Guadeloupe' },
                    { key: 'GMT-03:00 阿根廷', value: 'America/Argentina/Buenos_Aires' },
                    { key: 'GMT-02:00 迪诺罗尼亚群岛', value: 'America/Noronha' },
                    { key: 'GMT-01:00 佛得角普拉亚', value: 'Atlantic/Cape_Verde' },
                    { key: 'GMT+00:00 达喀尔', value: 'Africa/Dakar' },
                    { key: 'GMT+01:00 金沙萨', value: 'Africa/Kinshasa' },
                    { key: 'GMT+02:00 哈拉雷', value: 'Africa/Harare' },
                    { key: 'GMT+03:00 摩加迪沙', value: 'Africa/Mogadishu' },
                    { key: 'GMT+04:00 毛里求斯', value: 'Indian/Mauritius' },
                    { key: 'GMT+04:30 喀布尔', value: 'Asia/Kabul' },
                    { key: 'GMT+05:00 撒马尔罕', value: 'Asia/Samarkand' },
                    { key: 'GMT+05:30 哥伦布', value: 'Asia/Colombo' },
                    { key: 'GMT+06:00 达卡', value: 'Asia/Dhaka' },
                    { key: 'GMT+07:00 万象', value: 'Asia/Vientiane' },
                    { key: 'GMT+08:00 上海', value: 'Asia/Shanghai' },
                    { key: 'GMT+09:00 东京', value: 'Asia/Tokyo' },
                    { key: 'GMT+10:00 关岛', value: 'Pacific/Guam' },
                    { key: 'GMT+11:00 努美亚', value: 'Pacific/Noumea' },
                    { key: 'GMT+11:30 诺福克', value: 'Pacific/Norfolk' },
                    { key: 'GMT+12:00 瑙鲁', value: 'Pacific/Nauru' },
                    { key: 'GMT+13:00 汤加塔布岛', value: 'Pacific/Tongatapu' }
                ],
                periodTypeList: [
                    { name: 'hour(s)', value: 'hour' },
                    { name: 'day(s)', value: 'day' },
                    { name: 'week(s)', value: 'week' },
                    { name: 'month(s)', value: 'month' }
                ],
                durationTypeList: [
                    { name: 'hour(s)', value: 'hour' },
                    { name: 'day(s)', value: 'day' },
                    { name: 'week(s)', value: 'week' }
                ]
            };
        },
        created() {
            // 登录测试
            // 通用的action
            let actions = {
                title: this.$t('Actions'),
                key: this.$t('操作'),
                width: 150,
                align: 'center',
                render: (h, params) => {
                    return h('div', [
                        h('Button', {
                            props: {
                                type: 'primary',
                                size: 'small',
                                icon: 'ios-play'
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    this.startTask(params);
                                }
                            }
                        }),
                        h('Button', {
                            props: {
                                type: 'primary',
                                size: 'small',
                                icon: 'stop'
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    this.stopTask(params);
                                }
                            }
                        }),
                        h('Button', {
                            props: {
                                type: 'primary',
                                size: 'small',
                                icon: 'android-delete'
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    this.deleteTask(params);
                                }
                            }
                        }),
                        h('Button', {
                            props: {
                                type: 'primary',
                                size: 'small',
                                icon: 'android-settings'
                            },
                            style: {
                                marginRight: '5px'
                            },
                            on: {
                                click: () => {
                                    this.editTask(params);
                                }
                            }
                        })
                    ]);
                }
            };
            // 资产组表格配置
            this.taskReportsTableOfAccessGroup = {
                id: 'group_tab',
                index: true,
                loading: true,
                checkBox: true,
                // url: '/ssa/java/asset/group/groupList',
                type: 'table',
                ajaxType: 'get',
                data: {
                    index: 'asset',
                    type: 'group'
                },
                add_btn: false,
                del_btn: false,
                modify_btn: false,
                cols: [
                    {
                        title: this.$t('资产分组名'),
                        key: 'groupName'
                    },
                    {
                        title: this.$t('资产类型')
                    },
                    {
                        title: this.$t('主机IP')
                    },
                    {
                        title: this.$t('扫描进度')
                    },
                    {
                        title: this.$t('漏洞数')
                    },
                    {
                        title: this.$t('开始时间')
                    },
                    {
                        title: this.$t('扫描耗时')
                    },
                    actions
                ]
            };
            // 服务器表格配置
            this.taskReportsTableOfServer = {
                id: 'task_report_table_of_server',
                type: 'table',
                ajaxType: 'get',
                index: false,
                loading: false,
                checkBox: false,
                url: '/api/ssa_table',
                data: {
                    index: 'asset',
                    type: 'server'
                },
                add_btn: false,
                del_btn: false,
                modify_btn: false,
                cols: [
                    {
                        title: this.$t('服务器IP'),
                        key: 'serverIp',
                        render: (h, params) => {
                            return params.row._source.serverIp
                        }
                    },
                    {
                        title: this.$t('所属资产组')
                    },
                    {
                        title: this.$t('扫描进度')
                    },
                    {
                        title: this.$t('漏洞级别')
                    },
                    {
                        title: this.$t('漏洞数')
                    },
                    {
                        title: this.$t('开始时间')
                    },
                    {
                        title: this.$t('扫描耗时')
                    },
                    actions
                ]
            };
            // 终端表格配置  以下有部分假数据 注意替换
            this.taskReportsTableOfVM = {
                id: 'vm_tab',
                type: 'table',
                ajaxType: 'get',
                index: false,
                loading: false,
                checkBox: false,
                url: '/api/ssa_table',
                data: {
                    index: 'asset',
                    type: 'vm'
                },
                add_btn: false,
                del_btn: false,
                modify_btn: false,
                cols: [
                    {
                        title: this.$t('终端IP'),
                        key: 'vmIp',
                        render: (h, params) => {
                            return params.row._source.vmIp
                                ? this.createALink(
                                    h,
                                    params.row._source.vmIp,
                                    'task_detail',
                                    params.row
                                )
                                : h('div', '--');
                        }
                    },
                    {
                        title: this.$t('所属资产组')
                    },
                    {
                        title: this.$t('扫描进度'),
                        render: (h, params) => {
                            return params.row._source.vmIp
                                ? this.createProgress(h, 'done', 90)
                                : h('div', '--');
                        }
                    },
                    {
                        title: this.$t('漏洞级别')
                    },
                    {
                        title: this.$t('漏洞数'),
                        render: (h, params) => {
                            return params.row._source.vmIp
                                ? h('div', [
                                    this.createALink(h, '2', 'report', params.row),
                                    ' ( ',
                                    this.createALink(h, '3', 'report', params.row),
                                    ' ) '
                                ])
                                : h('div', '--');
                        }
                    },
                    {
                        title: this.$t('开始时间')
                    },
                    {
                        title: this.$t('扫描耗时'),
                        render: (h, params) => {
                            return params.row._source.vmIp
                                ? this.createALink(h, 'Aug 24 2018', 'report_detail', params.row)
                                : h('div', '--');
                        }
                    },
                    actions
                ]
            };
        },
        methods: {
            startTask(params) {
                // 配置任务
                console.log('config Task', params);
                //this.showTaskConfig = true;
                //this.taskConfig.scanTarget = params.row._source.vmIp;

                this.$http.post("/ssa/java/asset/scan/assetScanStart", {ip: params.row._source.vmIp}).then(res => {
                    if(res.code==0){
                        this.loading = false;
                        //刷新
                        //this.$refs.serverTab.changeParams();
                    }
                });

            },
            editTask(params) {
                // 修改任务
            },
            deleteTask(params) {
                // 删除任务
            },
            stopTask(params) {
                // 暂停任务
                this.$http.post("/ssa/java/asset/scan/assetScanStop", {ip: params.row._source.task_id}).then(res => {
                    if(res.code==0){
                        this.loading = false;
                        //刷新
                        //this.$refs.serverTab.changeParams();
                    }
                });
            },
            addSchedule(newSchedule) {
                // 添加时刻表
                console.log('add scedule', newSchedule);
                this.scheduleList.push(newSchedule);
            }
        }
    };
</script>

<style scoped>
  .loophole-task {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
    padding-bottom: 108px;
  }

  .loophole-task .loophole-task-tool-bar {
    padding: 8px;
  }

  .loophole-task-container {
    width: 100%;
    padding: 8px;
    color: white;
  }

  .loophole-task-container .loophole-task-title {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid white;
  }

  .loophole-task-container .loophole-task-display {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-around;
    /* margin-top: 16px; */
  }

  .loophole-task-display > div {
    box-sizing: border-box;
    flex: 0 1 32%;
    min-width: 280px;
    height: 200px;
    background-color: white;
    margin: 8px;
  }

  .loophole-task-display .loophole-task-chart-title {
    position: relative;
    text-align: center;
    background-color: gray;
    color: white;
  }

  .loophole-task-chart-title .loophole-task-chart-title-menu {
    position: absolute;
    left: 8px;
  }

  /** 重写 **/
  .ivu-dropdown-item {
    text-align: left;
  }
</style>
